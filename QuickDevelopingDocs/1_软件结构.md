# ICTFE 开发快速上手文档 - 1 软件结构

## 语言

如你所见, 这里面一堆`Python`脚本, 不用我说你也应该清楚这个玩意儿是用什么开发的.

`ICTFE`最初是在`Windows`平台上尝试使用`C#`, 配合着`IronPython`进行开发的一个项目, 但是开发仅持续了一天便被放弃. 原因是C#对跨平台图形化构建的支持极度匮乏(微软不愿意把`WinForm`移植到`Linux`平台), `IronPython`仅支持`Python2`并且有许多依赖难以解决, 于是为了对各个平台具有良好的兼容性, 并且能够使用一个强大而又方便的的UI构建技术, `ICTFE`最终选择了采用PyQt5进行开发. 虽然国内`PyQt5`的资料极度匮乏, 但是当前开发者通过有限的资料构建了一个模块化程度比较高的项目状态, 通过几个简单的`Demo`和分块开发, 即使在不甚了解`PyQt5`这样的一个框架的情况下仍然能够轻松地为`ICTFE`开发一些功能模块.

本文的目标是成为一个仅会`Python`基本语法的人阅读完之后也能快速投入开发并产出安全, 高质量代码的文档.

## 软件结构

PyQt5框架的基本容器(也就是所有控件, 比如按钮, 文本框之类的控件的父类, 不了解也没关系)是`QFrame`, 在此基础上的进一步开发后的基本容器是`QWidget`. 本软件的组织形式如下:

```
-----------------------------------------------------------------
| ------------------------------------------------------------- |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                      Central Widget                       | |<-MainWindow
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |-----------------------------------------------------------| |
-----------------------------------------------------------------
```

主窗口继承自`QMainWindow`类, 也就是`Qt`默认的主窗口类. 其布局内仅有一个`Central Widget`, 而后所有的控件的父控件都是`Central Widget`.

`Central Widget`的布局情况如下:

```
-----------------------------------------------------------------
|                                                               |
|         ----------------------------------------------------- |
| Button  |                                                   | |
|         |                                                   | |
| Button  |                                                   | |
|         |                                                   | |
| Button  |                    Type Stack                     | |<-Central Widget
|         |                 (QStackedWidget)                  | |
| Button  |                                                   | |
|         |                                                   | |
| Button  |                                                   | |
|         |                                                   | |
| ListBox |                                                   | |
|         ----------------------------------------------------- |
-----------------------------------------------------------------
```

主要的控件就是`QStackedWidget`. 这是一个能够将多个`Widget`(你们可以简单的将`QWidget`理解为一个面板, 可以放置各种按钮等其它控件的面板)组合在一起的控件, 就像一个面板切换器. 右侧的按钮用来切换`Stacked Widget`来显示不同的面板.

`Type Stack`中的面板:

* `Type Stack`
  * `Reverse Panel` 逆向工程功能分区
  * `Web Panel` Web功能分区
  * `Crypto Panel` 密码学功能分区
  * `Pwn Panel` Pwn 功能分区
  * `Misc Panel` 杂项功能分区

除了Type Stack之外, 页面上的其它控件:

* `Close Button` 右上角的关闭按钮
* `Mini Button` 右上角的最小化按钮
* `Reverse Button ~ Misc Button` 分别对应`Type Stack`内的各个分区, 点击即会让`Type Stack`呈现对应分区.
* `File Temp Stack` 文件暂存池, 他并不是一个`StackedWidget`, 而是一个`QListBox`, 用来展示不同的项目. 目前暂时无用, 今后将加入文件暂存功能.

`Type Stack`内不同`Panel`的统一布局如下:

```
-----------------------------------------------------------------
| ------------------------------------------------------------- |
| |                       Tool Buttons                        |<-Scroll Area
| ------------------------------------------------------------- |
|---------------------------------------------------------------|
| ------------------------------------------------------------- |
| |                                                           | |
| |                         Tool Stack                        | |<-Panel
| |                      (Stacked Widget)                     | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| |                                                           | |
| ------------------------------------------------------------- |
-----------------------------------------------------------------
```

上半部分是一个`Scroll Area`, 用来限制按钮所能显示的区域并提供滚动支持. 滚动区域内依旧是一个`QWidget`作为其它控件的放置面板, 上面放置了这个分类所有的功能分区按钮, 比如密码学分区的`Base系列`, `Url编码`之类的按钮. 每一个按钮都对应`Tool Stack`中的一个`Panel`, 而这个`Panel`上面则放置了该功能的具体实现控件. 切换模式和上文中切换不同分区的模式是一样的.

软件结构介绍完毕.

## 代码结构

如果上面软件结构看不甚懂的话也没有关系, 如果你对这个软件进行大规模改动, 那么基本的软件组织结构是不会变的.

接下来介绍本项目的代码组织结构.

### Run.py

这个文件中放置了`Main`函数和一个`MainWindow`类. `MainWindow`类继承于`MainWindow.py`中的`ui_MainWindow`类, 只包含一个初始化函数, 用于构建主窗口.

```python
class MainWindow(QMainWindow, MainWindow.Ui_MainWindow):
    def __init__(self, parent=None): # 初始化函数, 在类的对象声明时执行
        super(MainWindow, self).__init__(parent) # 使用super函数执行父类, 也就是ui_MainWindow类的初始化
        self.setupUi(self) # 执行父类ui_MainWindow的setupUi函数, 用来构建完整的用户界面
```

`Main`函数中则声明了一个MainWindow对象, 对对象进行简单的设置之后让其显示`Win.show()`, 然后进入Qt的主事件循环. 主事件循环可以简单的理解为一个无限循环, 一直等你单击了关闭按钮, 或者用任务管理器发出`SIGKILL`或者`SIGTERM`信号等关闭信号, 这个循环才会退出.

循环执行过程中会不断的对各种事件进行检查, 比如按钮是否被点击等, 如果点击了, 处理这个点击事件所发出的信号, 将所有接收这个信号的函数全部执行一遍. 当然这个循环是怎么实现的, 我们没有必要去了解.

关于Qt的事件触发机制设计有必要解释一下. Qt采用的是Qt原创并引以为豪的信号槽机制, 当控件状态改变时就广播一个包含该控件改变具体信息的信号, 所有接收该信号的函数接收到信号之后都会读取信号并开始执行. 你可以简单的把信号理解成是报纸, 发出信号的控件是送报人, 而接收信号的函数(槽)是订阅报纸的住户. 每当报纸发行的时候, 送报人就会把每家每户访问一遍, 并将报纸送到订阅了的住户手上. Qt的信号槽机制强大而灵活, 但它并不是ICTFE开发的重点, 关于信号槽的使用方式也十分简单, 所以不必去了解更多的信号槽用法也可以进行本项目的开发. 如果你想更深入的了解Qt开发, 请自行寻找资料去了解这样的一个设计.

### MainWindow.py

这个文件中定义了`Ui_MainWindow`类, 用于构建整个窗口.

类中包含了一个`setupUi`函数.

`setupUi`函数中调整了主窗口的各项属性, 包括窗口大小等.

紧接着在函数内声明了一个Central Widget以及其他的控件并对其进行属性设置, 将各个分类的panel加入Type Stack中, 参见上面的**软件结构**分类.

最后使用了`<object>.<event>.connect(<function>)`这样的语句, 这就是上面介绍的信号槽. 当`<object>`发生了`<event>`事件时便会执行`<function>`这个函数.

接下来是对setupUi中采用信号槽连接的各种函数的定义, 就是定义了一个动画, 定义开头位置, 结尾位置, 持续时间, 动画方式(位移), 并启动这个动画, 然后设定Type Stack中要展示的panel, 完成软件左侧的按钮点击时的所有需要干的事情.

## 其它Panel

我们在`MainWindow`类定义的上面可以看见`import`了`CryptoPanel`, 把它声明在主类里面, 并添加进了`TypeStack`. `Crypto Panel`的定义是定义在项目`Crypto`文件夹下面的. 这个文件夹下面有两个`Python`文件, 还有一大堆定义其他功能的模块. `ui_Crypto.py`构建了密码学模块的界面, `Crypto.py`中的`CryptoPanel`则继承了`ui_Crypto.py`中的`ui_Crypto.py`界面类, 定义了界面内中各种控件的信号函数, 并把他们连接到控件上面. 这种界面和逻辑代码分离的方式使得我们的开发变得简单了起来.

其他的模块组织方式亦是如此.
